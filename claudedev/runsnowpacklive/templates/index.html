<!DOCTYPE html>
<!-- snowpack_steiermark/templates/index.html -->
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SNOWPACK Steiermark ‚Äî {{ station_name }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .combined-tog {
      border: 2px solid var(--tog-color, #888);
      color: var(--tog-color, #888);
      background: transparent;
      opacity: 0.4;
      transition: opacity 0.15s, background 0.15s;
    }
    .combined-tog.combined-tog-on {
      background: var(--tog-color, #888);
      color: #fff;
      opacity: 1;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">üèîÔ∏è SNOWPACK Steiermark</span>
      <div class="d-flex align-items-center gap-3">
        <select id="station-select" class="form-select form-select-sm" style="width:auto;" onchange="onStationChange()">
          {% for s in stations %}
          <option value="{{ s.id }}">{{ s.name }} ({{ s.id }})</option>
          {% endfor %}
        </select>
        <span class="navbar-text text-light" id="current-date"></span>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-3">
    <div class="row g-3">

      <!-- Left column: Status -->
      <div class="col-lg-6">

        <!-- Simulation status -->
        <div class="card mb-3">
          <div class="card-header fw-bold">üì° Letzte Simulation</div>
          <div class="card-body">
            <span class="status-value" id="last-simulation">‚Äî</span>
            <span class="badge ms-2" id="sim-badge">‚Äî</span>
          </div>
        </div>

        <!-- Data download status -->
        <div class="card mb-3">
          <div class="card-header fw-bold">‚¨áÔ∏è Letzte Daten</div>
          <div class="card-body">
            <span class="status-value" id="last-download">‚Äî</span>
            <span class="badge ms-2" id="dl-badge">‚Äî</span>
          </div>
        </div>

        <!-- Snow cover -->
        <div class="card mb-3">
          <div class="card-header fw-bold">‚ùÑÔ∏è Aktuelle Schneedecke</div>
          <div class="card-body row">
            <div class="col-6 text-center">
              <div class="small text-muted">Schneeh√∂he</div>
              <div class="status-value" id="snow-height">‚Äî</div>
              <div class="small text-muted">cm</div>
            </div>
            <div class="col-6 text-center">
              <div class="small text-muted">Oberfl√§chentemp.</div>
              <div class="status-value" id="surface-temp">‚Äî</div>
              <div class="small text-muted">¬∞C</div>
            </div>
          </div>
        </div>

        <!-- Avalanche problems -->
        <div class="card mb-3">
          <div class="card-header fw-bold">‚ö†Ô∏è Lawinenprobleme heute</div>
          <div class="card-body">
            <span id="prob-new-snow"    class="problem-badge problem-inactive">‚ùÑÔ∏è Neuschnee</span>
            <span id="prob-wind-slab"   class="problem-badge problem-inactive">üå¨Ô∏è Triebschnee</span>
            <span id="prob-pwl"         class="problem-badge problem-inactive">üèîÔ∏è Altschnee/PWL</span>
            <span id="prob-wet-snow"    class="problem-badge problem-inactive">üíß Nassschnee</span>
          </div>
        </div>

      </div><!-- /left col -->

      <!-- Right column: Actions -->
      <div class="col-lg-6">
        <div class="card mb-3">
          <div class="card-header fw-bold">üéÆ Steuerung</div>
          <div class="card-body d-grid gap-2">

            <button id="btn-run" class="btn btn-primary btn-lg" onclick="startRun()">
              üîÑ Daten laden &amp; Simulation starten
            </button>

            <button class="btn btn-outline-secondary" onclick="openNivizModal()">
              üìä niViz √∂ffnen
            </button>

            <a href="/pro/download" class="btn btn-outline-secondary">
              ‚¨áÔ∏è PRO-Datei herunterladen
            </a>

            <button id="btn-avapro" class="btn btn-outline-secondary" onclick="toggleAvapro()">
              üî¨ AVAPRO: <span id="avapro-label">‚Ä¶</span>
            </button>

            <button class="btn btn-outline-dark" onclick="gitPush()">
              ‚òÅÔ∏è Git Push
            </button>

          </div>
        </div>

        <!-- Spinner + log output -->
        <div id="run-status-box" class="card mb-3 d-none">
          <div class="card-header fw-bold">üìã Simulation Log</div>
          <div class="card-body">
            <div id="run-spinner" class="spinner d-none"></div>
            <div id="run-result-badge" class="mb-2"></div>
            <pre id="log-output" class="mb-0"></pre>
          </div>
        </div>

        <!-- Git push result -->
        <div id="git-result" class="alert d-none" role="alert"></div>

      </div><!-- /right col -->
    </div><!-- /row -->

    <!-- Combined SMET + AVAPRO chart -->
    <div class="card mt-2">
      <div class="card-header fw-bold">üìä Saisonverlauf</div>
      <div class="card-body">

        <!-- Toggle row: Meteo variables -->
        <div class="mb-2 d-flex flex-wrap align-items-center gap-1">
          <small class="text-muted fw-bold me-1">Meteo:</small>
          <button id="tog-hs"   class="btn btn-sm combined-tog combined-tog-on" style="--tog-color:#1a6fbb;" onclick="toggleMeteoLayer('hs')">‚ùÑ HS</button>
          <button id="tog-ta"   class="btn btn-sm combined-tog" style="--tog-color:#e74c3c;" onclick="toggleMeteoLayer('ta')">üå° TA</button>
          <button id="tog-rh"   class="btn btn-sm combined-tog" style="--tog-color:#27ae60;" onclick="toggleMeteoLayer('rh')">üíß RH</button>
          <button id="tog-vw"   class="btn btn-sm combined-tog" style="--tog-color:#f39c12;" onclick="toggleMeteoLayer('vw')">üí® VW</button>
          <button id="tog-iswr" class="btn btn-sm combined-tog" style="--tog-color:#f1c40f;" onclick="toggleMeteoLayer('iswr')">‚òÄ ISWR</button>
        </div>

        <!-- Toggle row: AVAPRO problems -->
        <div class="mb-3 d-flex flex-wrap align-items-center gap-1">
          <small class="text-muted fw-bold me-1">Lawinenprobleme:</small>
          <button id="tog-new_snow"              class="btn btn-sm combined-tog combined-tog-on" style="--tog-color:#5dade2;" onclick="toggleAvaLayer('new_snow')">‚ùÑ Neuschnee</button>
          <button id="tog-wind_slab"             class="btn btn-sm combined-tog combined-tog-on" style="--tog-color:#f39c12;" onclick="toggleAvaLayer('wind_slab')">üå¨ Triebschnee</button>
          <button id="tog-persistent_weak_layer" class="btn btn-sm combined-tog combined-tog-on" style="--tog-color:#e74c3c;" onclick="toggleAvaLayer('persistent_weak_layer')">üèî Altschnee</button>
          <button id="tog-deep_slab"             class="btn btn-sm combined-tog combined-tog-on" style="--tog-color:#7b241c;" onclick="toggleAvaLayer('deep_slab')">‚¨á Altschnee (Tief)</button>
          <button id="tog-wet_snow"              class="btn btn-sm combined-tog combined-tog-on" style="--tog-color:#2471a3;" onclick="toggleAvaLayer('wet_snow')">üíß Nassschnee</button>
        </div>

        <!-- Chart.js meteo chart -->
        <div id="combined-chart-wrap" style="position:relative;">
          <canvas id="combined-chart" style="max-height:300px;"></canvas>
        </div>
        <!-- AVAPRO problem bands (aligned to chart area via canvas) -->
        <canvas id="combined-avapro-canvas" style="display:block;margin-top:3px;"></canvas>
        <div id="combined-empty" class="text-muted small py-2 d-none">Noch keine Daten vorhanden.</div>
      </div>
    </div>

  <!-- SMET raw data section -->
  <div class="card mt-3">
    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
      <span>üìä SMET Rohdaten ‚Äî Meteostation</span>
      <button class="btn btn-sm btn-outline-primary" onclick="toggleSmetCharts()">
        Daten anzeigen / verbergen
      </button>
    </div>
    <div id="smet-charts-box" class="card-body d-none">
      <div id="smet-loading" class="text-center text-muted py-3">
        <div class="spinner-border spinner-border-sm me-2"></div>
        Lade SMET-Daten‚Ä¶
      </div>
      <!-- HS full width -->
      <div class="mb-3">
        <div class="small fw-bold text-muted mb-1">Schneeh√∂he HS [cm]</div>
        <canvas id="smet-hs" style="max-height:220px;"></canvas>
      </div>
      <!-- 2-col grid for remaining variables -->
      <div class="row g-3">
        <div class="col-md-6">
          <div class="small fw-bold text-muted mb-1">Lufttemperatur TA [¬∞C]</div>
          <canvas id="smet-ta" style="max-height:180px;"></canvas>
        </div>
        <div class="col-md-6">
          <div class="small fw-bold text-muted mb-1">Relative Feuchte RH [%]</div>
          <canvas id="smet-rh" style="max-height:180px;"></canvas>
        </div>
        <div class="col-md-6">
          <div class="small fw-bold text-muted mb-1">Windgeschwindigkeit VW [m/s]</div>
          <canvas id="smet-vw" style="max-height:180px;"></canvas>
        </div>
        <div class="col-md-6">
          <div class="small fw-bold text-muted mb-1">Einstrahlung ISWR [W/m¬≤]</div>
          <canvas id="smet-iswr" style="max-height:180px;"></canvas>
        </div>
        <div class="col-md-6">
          <div class="small fw-bold text-muted mb-1">Niederschlag PSUM [mm]</div>
          <canvas id="smet-psum" style="max-height:180px;"></canvas>
        </div>
        <div class="col-md-6">
          <div class="small fw-bold text-muted mb-1">Niederschlagsphase PSUM_PH [0=Regen, 1=Schnee]</div>
          <canvas id="smet-ph" style="max-height:180px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  </div><!-- /container -->

  <script>
    // ----------------------------------------------------------------
    // Station selector
    // ----------------------------------------------------------------
    function selectedStation() {
      return document.getElementById("station-select").value;
    }

    function onStationChange() {
      loadStatus();
      loadCombinedChart();
      // Reset SMET chart cache so next open reloads for the new station
      _smetLoaded = false;
      const box = document.getElementById("smet-charts-box");
      if (!box.classList.contains("d-none")) {
        loadSmetCharts();
      }
    }

    // ----------------------------------------------------------------
    // Helpers
    // ----------------------------------------------------------------
    function formatDate(isoStr) {
      if (!isoStr) return "‚Äî";
      try {
        return new Date(isoStr).toLocaleString("de-AT");
      } catch { return isoStr; }
    }

    function ageBadge(isoStr) {
      if (!isoStr) return ["bg-secondary", "‚Äî"];
      const d = new Date(isoStr);
      const now = new Date();
      const diffH = (now - d) / 3600000;
      if (diffH < 26) return ["bg-success", "heute"];
      if (diffH < 50) return ["bg-warning text-dark", "gestern"];
      return ["bg-danger", "veraltet"];
    }

    function setProblem(id, active, color) {
      const el = document.getElementById(id);
      if (!el) return;
      if (active) {
        el.className = "problem-badge problem-active";
        el.style.backgroundColor = color;
      } else {
        el.className = "problem-badge problem-inactive";
        el.style.backgroundColor = "";
      }
    }

    // ----------------------------------------------------------------
    // Status polling
    // ----------------------------------------------------------------
    async function loadStatus() {
      try {
        const r = await fetch("/api/status?station=" + selectedStation());
        if (!r.ok) return;
        const s = await r.json();

        document.getElementById("last-simulation").textContent =
          s.last_simulation ? formatDate(s.last_simulation) : "‚Äî";
        const [simCls, simLbl] = ageBadge(s.last_simulation);
        const simBadge = document.getElementById("sim-badge");
        simBadge.className = "badge " + simCls;
        simBadge.textContent = simLbl;

        document.getElementById("last-download").textContent =
          s.last_download ? formatDate(s.last_download) : "‚Äî";
        const [dlCls, dlLbl] = ageBadge(s.last_download);
        const dlBadge = document.getElementById("dl-badge");
        dlBadge.className = "badge " + dlCls;
        dlBadge.textContent = dlLbl;

        document.getElementById("snow-height").textContent =
          s.snow_height_cm !== null ? s.snow_height_cm : "‚Äî";
        document.getElementById("surface-temp").textContent =
          s.surface_temp_c !== null ? s.surface_temp_c : "‚Äî";

        const p = s.problems || {};
        setProblem("prob-new-snow",  p.new_snow,              "#1a6fbb");
        setProblem("prob-wind-slab", p.wind_slab,             "#f07d00");
        setProblem("prob-pwl",       p.persistent_weak_layer, "#c0392b");
        setProblem("prob-wet-snow",  p.wet_snow,              "#f1c40f");

      } catch (e) {
        console.warn("Status fetch failed:", e);
      }
    }

    // ----------------------------------------------------------------
    // Run pipeline
    // ----------------------------------------------------------------
    let pollInterval = null;

    async function startRun() {
      const btn = document.getElementById("btn-run");
      btn.disabled = true;

      const box = document.getElementById("run-status-box");
      box.classList.remove("d-none");
      document.getElementById("run-spinner").classList.remove("d-none");
      document.getElementById("log-output").textContent = "Starte Pipeline‚Ä¶\n";
      document.getElementById("run-result-badge").innerHTML = "";

      try {
        await fetch("/run", { method: "POST" });
      } catch (e) {
        document.getElementById("log-output").textContent = "Fehler beim Starten: " + e;
        btn.disabled = false;
        return;
      }

      clearInterval(pollInterval);
      pollInterval = setInterval(pollRunStatus, 2000);
    }

    async function pollRunStatus() {
      try {
        const r = await fetch("/run/status");
        const data = await r.json();
        document.getElementById("log-output").textContent = data.log || "";

        if (data.status === "running") return;

        clearInterval(pollInterval);
        document.getElementById("run-spinner").classList.add("d-none");
        document.getElementById("btn-run").disabled = false;

        const badge = document.getElementById("run-result-badge");
        if (data.status === "ok") {
          badge.innerHTML = '<span class="badge bg-success">‚úì Abgeschlossen</span>';
        } else if (data.status === "error") {
          badge.innerHTML = '<span class="badge bg-danger">‚úó Fehler</span>';
        } else {
          badge.innerHTML = '<span class="badge bg-secondary">' + data.status + '</span>';
        }
        await loadStatus();
        await loadCombinedChart();
      } catch (e) {
        console.warn("Poll failed:", e);
      }
    }

    // ----------------------------------------------------------------
    // AVAPRO toggle
    // ----------------------------------------------------------------
    async function loadAvaproStatus() {
      try {
        const r = await fetch("/api/avapro-status");
        const d = await r.json();
        setAvaproLabel(d.avapro_enabled);
      } catch(e) {}
    }

    function setAvaproLabel(enabled) {
      const lbl = document.getElementById("avapro-label");
      const btn = document.getElementById("btn-avapro");
      if (enabled) {
        lbl.textContent = "AN";
        btn.classList.remove("btn-outline-danger");
        btn.classList.add("btn-outline-secondary");
      } else {
        lbl.textContent = "AUS";
        btn.classList.remove("btn-outline-secondary");
        btn.classList.add("btn-outline-danger");
      }
    }

    async function toggleAvapro() {
      try {
        const r = await fetch("/api/avapro-toggle", { method: "POST" });
        const d = await r.json();
        setAvaproLabel(d.avapro_enabled);
      } catch(e) {
        console.warn("AVAPRO toggle failed:", e);
      }
    }

    // ----------------------------------------------------------------
    // Git push
    // ----------------------------------------------------------------
    async function gitPush() {
      const el = document.getElementById("git-result");
      el.className = "alert alert-info";
      el.textContent = "Pushe zu GitHub‚Ä¶";
      el.classList.remove("d-none");
      try {
        const r = await fetch("/git-push", { method: "POST" });
        const data = await r.json();
        if (data.success) {
          el.className = "alert alert-success";
          el.textContent = "‚úì " + (data.output || "Erfolgreich gepusht.");
        } else {
          el.className = "alert alert-danger";
          el.textContent = "‚úó " + (data.output || "Push fehlgeschlagen.");
        }
      } catch (e) {
        el.className = "alert alert-danger";
        el.textContent = "Fehler: " + e;
      }
    }

    // ----------------------------------------------------------------
    // Combined SMET + AVAPRO chart
    // ----------------------------------------------------------------
    let combinedChart = null;
    let _combinedData = null;
    let _crosshairListenersAdded = false;

    // Crosshair plugin ‚Äî draws vertical line on chart canvas
    const _crosshairPlugin = {
      id: "crosshair",
      afterDraw(chart) {
        if (chart._crosshairX == null) return;
        const { ctx, chartArea } = chart;
        const x = chart._crosshairX;
        if (x < chartArea.left || x > chartArea.right) return;
        ctx.save();
        ctx.strokeStyle = "rgba(50,50,50,0.5)";
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 3]);
        ctx.beginPath();
        ctx.moveTo(x, chartArea.top);
        ctx.lineTo(x, chartArea.bottom);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.restore();
      }
    };

    // Meteo layer definitions
    // ta_max and ta_min share the same togKey "ta" ‚Äî one button controls both
    const _METEO_LAYERS = [
      { togKey: "hs",   dataKey: "hs_cm",    label: "HS [cm]",        color: "rgba(26,111,187,0.65)",  type: "bar",  yAxis: "yHs",   defaultOn: true  },
      { togKey: "ta",   dataKey: "ta_max",   label: "TA max [¬∞C]",    color: "rgb(231,76,60)",         type: "line", yAxis: "yTa",   defaultOn: false, fillNext: true },
      { togKey: "ta",   dataKey: "ta_min",   label: "TA min [¬∞C]",    color: "rgba(231,76,60,0.35)",   type: "line", yAxis: "yTa",   defaultOn: false, borderDash: [4,3] },
      { togKey: "rh",   dataKey: "rh_pct",   label: "RH [%]",         color: "rgb(39,174,96)",         type: "line", yAxis: "yRh",   defaultOn: false },
      { togKey: "vw",   dataKey: "vw_ms",    label: "VW max [m/s]",   color: "rgb(243,156,18)",        type: "line", yAxis: "yVw",   defaultOn: false },
      { togKey: "iswr", dataKey: "iswr_wm2", label: "ISWR max [W/m¬≤]",color: "rgb(241,196,15)",        type: "line", yAxis: "yIswr", defaultOn: false },
    ];

    // AVAPRO problem definitions (no Gleitschnee; Tiefer Schnee ‚Üí Altschnee (Tief))
    const _AVA_LAYERS = [
      { key: "new_snow",              label: "Neuschnee",        color: "#5dade2" },
      { key: "wind_slab",             label: "Triebschnee",      color: "#f39c12" },
      { key: "persistent_weak_layer", label: "Altschnee",        color: "#e74c3c" },
      { key: "deep_slab",             label: "Altschnee (Tief)", color: "#7b241c" },
      { key: "wet_snow",              label: "Nassschnee",       color: "#2471a3" },
    ];

    // Visibility state
    const _vis = {};
    _METEO_LAYERS.forEach(m => { _vis[m.togKey] = m.defaultOn; });
    _AVA_LAYERS.forEach(a => { _vis[a.key] = true; });

    async function loadCombinedChart() {
      document.getElementById("combined-empty").classList.add("d-none");
      try {
        const r = await fetch("/api/combined-chart?station=" + selectedStation());
        _combinedData = await r.json();
        _buildCombinedChart();
      } catch (e) {
        console.warn("Combined chart load failed:", e);
      }
    }

    function _buildCombinedChart() {
      const d = _combinedData;
      const labels = d.dates || [];
      if (!labels.length) {
        document.getElementById("combined-empty").classList.remove("d-none");
        document.getElementById("combined-avapro-canvas").style.display = "none";
        return;
      }

      const ctx = document.getElementById("combined-chart").getContext("2d");
      if (combinedChart) combinedChart.destroy();

      // Build datasets; ta_max gets fill: '+1' to shade down to ta_min
      const datasets = _METEO_LAYERS.map((m, idx) => {
        const ds = {
          label: m.label,
          data: d[m.dataKey] || [],
          borderColor: m.color,
          backgroundColor: m.fillNext ? "rgba(231,76,60,0.12)" : m.color,
          fill: m.fillNext ? "+1" : false,
          type: m.type,
          yAxisID: m.yAxis,
          pointRadius: 0,
          borderWidth: m.type === "bar" ? 0 : 1.5,
          barPercentage: 1.0,
          categoryPercentage: 1.0,
          hidden: !_vis[m.togKey],
          _togKey: m.togKey,
        };
        if (m.borderDash) ds.borderDash = m.borderDash;
        return ds;
      });

      combinedChart = new Chart(ctx, {
        plugins: [_crosshairPlugin],
        type: "bar",
        data: { labels, datasets },
        options: {
          responsive: true,
          animation: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: { ticks: { maxTicksLimit: 12, font: { size: 10 } } },
            yHs:   { type: "linear", display: _vis.hs,   position: "left",
                     title: { display: true, text: "HS [cm]", font: { size: 10 } }, min: 0 },
            yTa:   { type: "linear", display: _vis.ta,   position: "right",
                     title: { display: true, text: "TA [¬∞C]", font: { size: 10 } },
                     grid: { drawOnChartArea: false } },
            yRh:   { type: "linear", display: false, min: 0, max: 100 },
            yVw:   { type: "linear", display: false, min: 0 },
            yIswr: { type: "linear", display: false, min: 0 },
          },
        },
      });

      _addCrosshairListeners();
      // Draw AVAPRO bands after Chart.js finishes rendering
      setTimeout(() => _drawAvaproBands(null), 80);
    }

    function _drawAvaproBands(crosshairX) {
      const canvas = document.getElementById("combined-avapro-canvas");
      const chartCanvas = document.getElementById("combined-chart");
      if (!combinedChart || !_combinedData || !chartCanvas) { canvas.style.display = "none"; return; }

      const d = _combinedData;
      const nDays = (d.dates || []).length;
      if (!nDays) { canvas.style.display = "none"; return; }

      const ca = combinedChart.chartArea;
      if (!ca) { canvas.style.display = "none"; return; }

      const visible = _AVA_LAYERS.filter(a => _vis[a.key]);
      if (!visible.length) { canvas.style.display = "none"; return; }

      const ROW_H  = 22;
      // Use full chart canvas CSS width so crosshair x coordinates align exactly
      const totalW = chartCanvas.offsetWidth;
      const totalH = visible.length * ROW_H + 2;
      const labelW = ca.left;
      const dataW  = ca.right - ca.left;
      const cellW  = dataW / nDays;

      canvas.width  = totalW;
      canvas.height = totalH;
      canvas.style.display = "block";
      canvas.style.width   = totalW + "px";

      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, totalW, totalH);

      visible.forEach((prob, rowIdx) => {
        const y = rowIdx * ROW_H + 1;

        // row label
        ctx.font      = "10px system-ui, sans-serif";
        ctx.fillStyle = "#444";
        ctx.textAlign = "right";
        ctx.fillText(prob.label, labelW - 4, y + ROW_H / 2 + 3);

        // day cells
        d.dates.forEach((_, i) => {
          const active = d[prob.key] && d[prob.key][i];
          ctx.fillStyle = active ? prob.color : "#ececec";
          ctx.fillRect(ca.left + i * cellW, y, cellW - 0.5, ROW_H - 2);
        });

        // row border
        ctx.strokeStyle = "#ccc";
        ctx.strokeRect(ca.left, y, nDays * cellW, ROW_H - 2);
      });

      // --- crosshair ruler ---
      if (crosshairX != null && crosshairX >= ca.left && crosshairX <= ca.right) {
        ctx.strokeStyle = "rgba(50,50,50,0.5)";
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 3]);
        ctx.beginPath();
        ctx.moveTo(crosshairX, 0);
        ctx.lineTo(crosshairX, totalH);
        ctx.stroke();
        ctx.setLineDash([]);

        // date label above the first row
        const dayIdx = Math.round((crosshairX - ca.left) / cellW);
        if (dayIdx >= 0 && dayIdx < d.dates.length) {
          const dateStr = d.dates[dayIdx];
          ctx.font = "bold 10px system-ui, sans-serif";
          ctx.fillStyle = "rgba(0,0,0,0.75)";
          ctx.textAlign = crosshairX > totalW - 80 ? "right" : "left";
          const lx = crosshairX > totalW - 80 ? crosshairX - 3 : crosshairX + 3;
          ctx.fillText(dateStr, lx, 11);
        }
      }
    }

    function _addCrosshairListeners() {
      if (_crosshairListenersAdded) return;
      _crosshairListenersAdded = true;
      const canvas = document.getElementById("combined-chart");
      canvas.addEventListener("mousemove", function(e) {
        if (!combinedChart) return;
        const rect = this.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const ca = combinedChart.chartArea;
        if (!ca) return;
        const newX = (x >= ca.left && x <= ca.right) ? x : null;
        if (newX !== combinedChart._crosshairX) {
          combinedChart._crosshairX = newX;
          combinedChart.update("none");
          _drawAvaproBands(newX);
        }
      });
      canvas.addEventListener("mouseleave", function() {
        if (!combinedChart) return;
        combinedChart._crosshairX = null;
        combinedChart.update("none");
        _drawAvaproBands(null);
      });
    }

    function toggleMeteoLayer(togKey) {
      _vis[togKey] = !_vis[togKey];
      const btn = document.getElementById("tog-" + togKey);
      if (btn) btn.classList.toggle("combined-tog-on", _vis[togKey]);
      if (!combinedChart) return;

      combinedChart.data.datasets.forEach(ds => {
        if (ds._togKey === togKey) ds.hidden = !_vis[togKey];
      });
      const axisMap = { hs: "yHs", ta: "yTa", rh: "yRh", vw: "yVw", iswr: "yIswr" };
      if (axisMap[togKey]) {
        combinedChart.options.scales[axisMap[togKey]].display = _vis[togKey];
      }
      combinedChart.update();
      const cx = combinedChart._crosshairX ?? null;
      setTimeout(() => _drawAvaproBands(cx), 50);
    }

    function toggleAvaLayer(avaKey) {
      _vis[avaKey] = !_vis[avaKey];
      const btnId = "tog-" + avaKey;
      const btn = document.getElementById(btnId);
      if (btn) btn.classList.toggle("combined-tog-on", _vis[avaKey]);
      _drawAvaproBands(combinedChart ? (combinedChart._crosshairX ?? null) : null);
    }

    // ----------------------------------------------------------------
    // Init
    // ----------------------------------------------------------------
    document.getElementById("current-date").textContent =
      new Date().toLocaleDateString("de-AT", {
        weekday: "long", year: "numeric", month: "long", day: "numeric"
      });

    loadStatus();
    loadCombinedChart();
    loadAvaproStatus();
    setInterval(loadStatus, 60000);

    // ----------------------------------------------------------------
    // SMET raw data charts
    // ----------------------------------------------------------------
    const _smetCharts = {};
    let _smetLoaded = false;

    function _makeChart(id, label, color, data, labels, yLabel, fill) {
      const ctx = document.getElementById(id);
      if (!ctx) return;
      if (_smetCharts[id]) _smetCharts[id].destroy();
      _smetCharts[id] = new Chart(ctx.getContext("2d"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label,
            data,
            borderColor: color,
            backgroundColor: fill ? color.replace(")", ",0.12)").replace("rgb", "rgba") : "transparent",
            fill: !!fill,
            tension: 0.2,
            pointRadius: 0,
            borderWidth: 1.5,
          }]
        },
        options: {
          responsive: true,
          animation: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { maxTicksLimit: 8, font: { size: 10 } } },
            y: { title: { display: true, text: yLabel, font: { size: 10 } } }
          }
        }
      });
    }

    async function loadSmetCharts() {
      document.getElementById("smet-loading").classList.remove("d-none");
      try {
        const r = await fetch("/api/smet-data?station=" + selectedStation());
        const d = await r.json();
        const labels = (d.dates || []).map(ts => ts.replace("T", " ").replace("Z", "").slice(0, 16));

        _makeChart("smet-hs",   "HS [cm]",          "rgb(26,111,187)",  d.hs_cm,   labels, "cm",   true);
        _makeChart("smet-ta",   "TA [¬∞C]",          "rgb(231,76,60)",   d.ta_c,    labels, "¬∞C",   false);
        _makeChart("smet-rh",   "RH [%]",           "rgb(39,174,96)",   d.rh_pct,  labels, "%",    false);
        _makeChart("smet-vw",   "VW [m/s]",         "rgb(243,156,18)",  d.vw_ms,   labels, "m/s",  false);
        _makeChart("smet-iswr", "ISWR [W/m¬≤]",      "rgb(241,196,15)",  d.iswr_wm2,labels, "W/m¬≤", true);
        _makeChart("smet-psum", "PSUM [mm]",         "rgb(155,89,182)",  d.psum_mm, labels, "mm",   true);
        _makeChart("smet-ph",   "Phase (1=Schnee)",  "rgb(52,152,219)",  d.psum_ph, labels, "‚Äî",    false);

        _smetLoaded = true;
      } catch(e) {
        console.warn("SMET chart load failed:", e);
      }
      document.getElementById("smet-loading").classList.add("d-none");
    }

    async function toggleSmetCharts() {
      const box = document.getElementById("smet-charts-box");
      box.classList.toggle("d-none");
      if (!box.classList.contains("d-none") && !_smetLoaded) {
        await loadSmetCharts();
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- niViz PRO file selector modal -->
  <div class="modal fade" id="nivizModal" tabindex="-1" aria-labelledby="nivizModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="nivizModalLabel">üìä PRO-Datei f√ºr niViz ausw√§hlen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info py-2 small mb-3">
            Datei ausw√§hlen ‚Üí automatischer Download + niViz √∂ffnet sich in neuem Tab.<br>
            Im niViz-Fenster: <strong>File ‚Üí Open</strong> ‚Üí heruntergeladene <code>.pro</code> Datei w√§hlen.
          </div>
          <div id="pro-file-list">
            <div class="text-center text-muted py-3">
              <div class="spinner-border spinner-border-sm me-2"></div>
              Lade PRO-Dateien‚Ä¶
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <a href="https://run.niviz.org" target="_blank" class="btn btn-success">
            üåê niViz direkt √∂ffnen
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let nivizModalInstance = null;

    async function openNivizModal() {
      const modal = document.getElementById("nivizModal");
      nivizModalInstance = bootstrap.Modal.getOrCreateInstance(modal);
      nivizModalInstance.show();
      await loadProFiles();
    }

    async function loadProFiles() {
      const container = document.getElementById("pro-file-list");
      try {
        const r = await fetch("/api/pro-files");
        const files = await r.json();

        if (!files.length) {
          container.innerHTML = '<p class="text-muted text-center py-3">Keine PRO-Dateien vorhanden.<br>Bitte zuerst eine Simulation starten.</p>';
          return;
        }

        let html = '<div class="list-group">';
        for (const f of files) {
          const dt = new Date(f.modified).toLocaleString("de-AT");
          html += `
            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    onclick="selectProFile('${f.name}')">
              <span>
                <span class="fw-bold">üìÑ ${f.name}</span>
                <span class="text-muted ms-3 small">${dt}</span>
              </span>
              <span class="badge bg-secondary">${f.size_kb} KB</span>
            </button>`;
        }
        html += '</div>';
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = '<p class="text-danger text-center py-3">Fehler beim Laden der PRO-Dateien.</p>';
      }
    }

    function selectProFile(filename) {
      // Close modal first
      if (nivizModalInstance) nivizModalInstance.hide();

      // Open our niViz page ‚Äî it fetches the file and provides a drag handle
      window.open(`/niviz?file=${encodeURIComponent(filename)}`, "_blank");
    }
  </script>
</body>
</html>
